# Resumo da Arquitetura Xdebug na Aplicação (Direct Connection Strategy)

Este documento descreve o funcionamento do sistema de debug multi-utilizador implementado, adaptado para suportar **Xdebug 3** sem a necessidade de um Proxy dedicado.

## 1. Visão Geral
O sistema permite que múltiplos desenvolvedores façam debug simultaneamente na mesma aplicação WEB. Para contornar a limitação do Xdebug 3 (que não permite definir portas dinâmicas via `ini_set`), utilizamos a função `xdebug_connect_to_client` para forçar a ligação a uma porta específica alocada para cada sessão de utilizador.

## 2. Componentes Principais

### Frontend (Browser)
*   **[debug.controller.js](file:///c:/Users/isr-rsilva.ISRETAIL/Desktop/xdebug/debug.controller.js)**: Controlador UI (SAPUI5/OpenUI5). Gere a lista de sessões de debug, inicia novas sessões, envia comandos (STEP, RUN, STOP) e exibe o código fonte e consola.

### Backend (Servidor)
*   **[debugSession.php](file:///c:/Users/isr-rsilva.ISRETAIL/Desktop/xdebug/debugSession.php) (O "Servidor de Sessão")**:
    *   É iniciado quando o utilizador clica em "Start" no frontend.
    *   Abre dois sockets:
        *   **PortX (ex: 9005)**: Escuta conexões vindas do Xdebug (PHP).
        *   **PortG (ex: 9006)**: Escuta comandos vindos do frontend (GUI).
    *   Mantém-se vivo num loop (`while(true)`) à espera de atividade.
    *   No Windows, garante portas únicas para cada utilizador (fix `so_reuseaddr` removido).

*   **[wpms.php](file:///c:/Users/isr-rsilva.ISRETAIL/Desktop/xdebug/wpms.php) (A Aplicação Alvo)**:
    *   É o script principal que corre a lógica de negócio quando se clica nos botões da aplicação.
    *   Contém a função [wpms_session_read](file:///c:/Users/isr-rsilva.ISRETAIL/Desktop/xdebug/wpms.php#246-311) que intercepta o início do pedido.
    *   Lê a configuração da sessão para saber onde está o [debugSession.php](file:///c:/Users/isr-rsilva.ISRETAIL/Desktop/xdebug/debugSession.php) daquele utilizador.

*   **[debug.php](file:///c:/Users/isr-rsilva.ISRETAIL/Desktop/xdebug/debug.php) (O "Carteiro")**:
    *   Script intermediário que recebe comandos AJAX do frontend ([debug.controller.js](file:///c:/Users/isr-rsilva.ISRETAIL/Desktop/xdebug/debug.controller.js)).
    *   Reencaminha esses comandos para o [debugSession.php](file:///c:/Users/isr-rsilva.ISRETAIL/Desktop/xdebug/debugSession.php) através da **PortG**.

## 3. Fluxo de Execução (Passo a Passo)

### Fase 1: Início da Sessão (Setup)
1.  **Frontend**: O utilizador clica em "Start Debug". [debug.controller.js](file:///c:/Users/isr-rsilva.ISRETAIL/Desktop/xdebug/debug.controller.js) faz um pedido a [debugSession.php](file:///c:/Users/isr-rsilva.ISRETAIL/Desktop/xdebug/debugSession.php).
2.  **debugSession.php**:
    *   Procura um par de portas livres no servidor (ex: 9001/9002, 9003/9004...).
    *   Abre um **Socket Server** nessas portas.
    *   Guarda na Base de Dados (tabela `I0011`) que este utilizador está à escuta na Porta 9001 com a Chave `12345`.
    *   Retorna as portas ao frontend e entra em modo de espera (Loop).

### Fase 2: O Gatilho (Trigger)
3.  **Frontend**: O utilizador usa a aplicação normalmente.
4.  **wpms.php**: Ao receber um pedido, executa [wpms_session_read](file:///c:/Users/isr-rsilva.ISRETAIL/Desktop/xdebug/wpms.php#246-311).
    *   Verifica se existe uma sessão de debug ativa na BD.
    *   Recupera o IP e a **Porta X** (ex: 9001) guardados na Fase 1.
    *   **Ponto Crítico (Xdebug 3)**: Em vez de confiar na configuração automática, chama `xdebug_connect_to_client('host', 9001)`. Isto força o Xdebug a ignorar a sua configuração estática e ligar-se àquele processo específico.
    *   Chama `xdebug_break()` para pausar a execução imediatamente.

### Fase 3: O Ciclo de Debug
5.  **Xdebug**: Liga-se à Porta 9001 (onde o [debugSession.php](file:///c:/Users/isr-rsilva.ISRETAIL/Desktop/xdebug/debugSession.php) está à escuta).
6.  **debugSession.php**: Aceita a conexão. Agora ele tem o controlo da execução PHP.
    *   Envia o estado "break" para o Frontend via Porta G (ou espera query).
7.  **Frontend**: Recebe o estado, ilumina a linha atual no editor de código.
8.  **Utilizador**: Clica em "Step Over".
9.  **Frontend** -> **debug.php** -> **debugSession.php**: O comando viaja até ao processo de sessão.
10. **debugSession.php** -> **Xdebug**: Envia o comando DBGP para o PHP avançar uma linha.

## 4. Por que funciona no Xdebug 3?
A arquitetura tradicional falha no Xdebug 3 porque `ini_set('xdebug.client_port', ...)` é ignorado. A nossa solução contorna isto usando a API manual `xdebug_connect_to_client`, que permite especificar a porta de destino explicitamente em tempo de execução, restaurando a capacidade de ter múltiplos utilizadores em portas diferentes.
